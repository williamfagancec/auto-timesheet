// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  hashedPassword String?  // Optional: null for OAuth-only users
  createdAt      DateTime @default(now())

  sessions        Session[]
  projects        Project[]
  entries         TimesheetEntry[]
  rules           CategoryRule[]
  calendars       CalendarConnection[]
  events          CalendarEvent[]
  suggestionLogs  SuggestionLog[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CalendarConnection {
  id                  String   @id @default(cuid())
  userId              String
  provider            String   @default("google")
  accessToken         String
  refreshToken        String?
  expiresAt           DateTime?
  selectedCalendarIds Json?    // Array of calendar IDs to sync
  timezone            String   @default("UTC") // User's timezone (e.g., "Australia/Sydney")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

model Project {
  id         String   @id @default(cuid())
  userId     String
  name       String
  isArchived Boolean  @default(false)
  lastUsedAt DateTime @default(now())
  useCount   Int      @default(0)
  createdAt  DateTime @default(now())

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries         TimesheetEntry[]
  rules           CategoryRule[]
  suggestionLogs  SuggestionLog[]

  @@index([userId, lastUsedAt])
}

model CalendarEvent {
  id            String   @id @default(cuid())
  googleEventId String
  userId        String
  calendarId    String   // Google Calendar ID this event belongs to
  title         String
  startTime     DateTime
  endTime       DateTime
  attendees     Json?
  location      String?
  status        String   @default("confirmed") // confirmed, tentative, cancelled
  isAllDay      Boolean  @default(false)
  splitIndex    Int      @default(0) // 0 for non-split events, 1,2,3... for multi-day splits
  isDeleted     Boolean  @default(false) // Soft delete flag
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry           TimesheetEntry?
  suggestionLogs  SuggestionLog[]

  @@unique([userId, googleEventId, splitIndex])
  @@index([userId, startTime])
  @@index([userId, isDeleted])
}

model TimesheetEntry {
  id        String   @id @default(cuid())
  userId    String
  eventId   String?  @unique
  projectId String?
  date      DateTime
  duration  Int // in minutes
  isManual  Boolean  @default(false)
  isSkipped Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  event   CalendarEvent? @relation(fields: [eventId], references: [id])
  project Project?       @relation(fields: [projectId], references: [id])

  @@index([userId, date])
}

model CategoryRule {
  id               String    @id @default(cuid())
  userId           String
  ruleType         String    // TITLE_KEYWORD, ATTENDEE_EMAIL, ATTENDEE_DOMAIN, CALENDAR_NAME, RECURRING_EVENT_ID
  condition        String    // The pattern to match (e.g., keyword, email, domain, calendar ID, or event ID)
  projectId        String
  confidenceScore  Float     @default(0.5) // Base confidence score (0.0-1.0)
  matchCount       Int       @default(0)   // Number of times this rule has been matched
  totalSuggestions Int       @default(0)   // Total times this rule was suggested (accepted or rejected)
  accuracy         Float     @default(0)   // Success rate: acceptedCount / totalSuggestions
  lastMatchedAt    DateTime? // Last time this rule was matched/suggested
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId, ruleType])
  @@index([userId, condition])
  @@index([userId, projectId])
}

model SuggestionLog {
  id                  String   @id @default(cuid())
  userId              String
  eventId             String
  suggestedProjectId  String
  confidence          Float    // Confidence score of the suggestion (0.0-1.0)
  outcome             String   // ACCEPTED, REJECTED, IGNORED
  createdAt           DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  event   CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  project Project       @relation(fields: [suggestedProjectId], references: [id], onDelete: Cascade)

  @@index([userId, outcome])
  @@index([userId, createdAt])
  @@index([eventId])
}
